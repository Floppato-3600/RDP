name: RDP

on:
Â  workflow_dispatch:
Â  workflow_call:

jobs:
Â  secure-rdp:
Â  Â  runs-on: windows-2022
Â  Â  timeout-minutes: 3600

Â  Â  steps:
Â  Â  Â  - name: Configure Core RDP Settings
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Name "fDenyTSConnections" -Value 0 -Force
Â  Â  Â  Â  Â  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Name "UserAuthentication" -Value 0 -Force
Â  Â  Â  Â  Â  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Name "SecurityLayer" -Value 0 -Force

Â  Â  Â  Â  Â  # Abrir puerto 3389
Â  Â  Â  Â  Â  netsh advfirewall firewall delete rule name="RDP-Tailscale"
Â  Â  Â  Â  Â  netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

Â  Â  Â  Â  Â  Restart-Service -Name TermService -Force

Â  Â  Â  - name: Create RDP User with Secure Password
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  $password = "FLP4600@@"
Â  Â  Â  Â  Â  $securePass = ConvertTo-SecureString $password -AsPlainText -Force

Â  Â  Â  Â  Â  if (Get-LocalUser -Name "Floppato" -ErrorAction SilentlyContinue) {
Â  Â  Â  Â  Â  Â  Â  Remove-LocalUser -Name "Floppato"
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  New-LocalUser -Name "Floppato" -Password $securePass -AccountNeverExpires

Â  Â  Â  Â  Â  Add-LocalGroupMember -Group "Administrators" -Member "Floppato"
Â  Â  Â  Â  Â  Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Floppato"

Â  Â  Â  Â  Â  echo "RDP_CREDS=User: Floppato | Password: $password" >> $env:GITHUB_ENV

Â  Â  Â  - name: Install Tailscale
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
Â  Â  Â  Â  Â  $installerPath = "$env:TEMP\tailscale.msi"

Â  Â  Â  Â  Â  Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
Â  Â  Â  Â  Â  Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
Â  Â  Â  Â  Â  Remove-Item $installerPath -Force

Â  Â  Â  - name: Establish Tailscale Connection
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

Â  Â  Â  Â  Â  $tsIP = $null
Â  Â  Â  Â  Â  $retries = 0
Â  Â  Â  Â  Â  while (-not $tsIP -and $retries -lt 10) {
Â  Â  Â  Â  Â  Â  Â  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
Â  Â  Â  Â  Â  Â  Â  Start-Sleep -Seconds 5
Â  Â  Â  Â  Â  Â  Â  $retries++
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (-not $tsIP) {
Â  Â  Â  Â  Â  Â  Â  Write-Error "Tailscale IP not assigned. Exiting."
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      - name: Install Visual Studio Code
        run: |
          $vscodeUrl = "https://update.code.visualstudio.com/latest/win32-x64-user/stable"
          $installerPath = "$env:TEMP\vscode.exe"

          Invoke-WebRequest -Uri $vscodeUrl -OutFile $installerPath
          Start-Process $installerPath -ArgumentList "/VERYSILENT", "/MERGETASKS=!runcode" -Wait
          Remove-Item $installerPath -Force

      - name: Install Node.js LTS
        run: |
          $nodeUrl = "https://nodejs.org/dist/v24.11.1/node-v24.11.1-x64.msi"
          $installerPath = "$env:TEMP\node.msi"

          Write-Host "Downloading Node from $nodeUrl"
          Invoke-WebRequest -Uri $nodeUrl -OutFile $installerPath

          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

          node -v
          npm -v


      - name: Install Discord
        run: |
          $discordUrl = "https://discord.com/api/download?platform=win"
          $installerPath = "$env:TEMP\discord.exe"

          Invoke-WebRequest -Uri $discordUrl -OutFile $installerPath
          Start-Process $installerPath -ArgumentList "/S" -Wait
          Remove-Item $installerPath -Force
          
Â  Â  Â  - name: Verify RDP Accessibility
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Write-Host "Tailscale IP: $env:TAILSCALE_IP"
Â  Â  Â  Â  Â  $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
Â  Â  Â  Â  Â  if (-not $testResult.TcpTestSucceeded) {
Â  Â  Â  Â  Â  Â  Â  Write-Error "TCP connection to RDP port 3389 failed"
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Write-Host "TCP connectivity successful!"

Â  Â  Â  ###################################################################
Â  Â  Â  # ðŸŸ¢ CronÃ³metro real para el auto-reinicio
Â  Â  Â  ###################################################################
Â  Â  Â  - name: Maintain Connection with Auto-Restart
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Write-Host "`n=== RDP ACCESS ==="
Â  Â  Â  Â  Â  Write-Host "Address: $env:TAILSCALE_IP"
Â  Â  Â  Â  Â  Write-Host "Username: Floppato"
Â  Â  Â  Â  Â  Write-Host "Password: FLP4600@@"
Â  Â  Â  Â  Â  Write-Host "==================`n"

Â  Â  Â  Â  Â  # Tiempo lÃ­mite: 5 horas 40 minutos
Â  Â  Â  Â  Â  $limit = (Get-Date).AddHours(5).AddMinutes(40)

Â  Â  Â  Â  Â  while ($true) {
Â  Â  Â  Â  Â  Â  Â  # Si se cumple el tiempo => enviar dispatch
Â  Â  Â  Â  Â  Â  Â  if (Get-Date -ge $limit) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Write-Host "Launching repository_dispatch restart..."

Â  Â  Â  Â  Â  Â  Â  Â  Â  $headers = @{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Accept" = "application/vnd.github+json"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Authorization" = "Bearer $env:GITHUB_TOKEN"
Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  $body = '{"event_type": "restart_rdp"}'

Â  Â  Â  Â  Â  Â  Â  Â  Â  Invoke-RestMethod -Method Post `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Uri "https://api.github.com/repos/${env:GITHUB_REPOSITORY}/dispatches" `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Headers $headers `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -Body $body `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  -ContentType "application/json"

Â  Â  Â  Â  Â  Â  Â  Â  Â  Write-Host "Restart dispatched!"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Start-Sleep -Seconds 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  exit 0
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Write-Host "[$(Get-Date)] RDP Active - waiting..."
Â  Â  Â  Â  Â  Â  Â  Start-Sleep -Seconds 300
Â  Â  Â  Â  Â  }
